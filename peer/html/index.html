<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8" />
	<title>middleware</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
	<meta name="apple-mobile-web-app-capable" content="yes" />
	<link href="./css/bootstrap.min.css" rel="stylesheet" />
	<link href="./css/adminia.css" rel="stylesheet" />
	<link href="./css/tablestyle.css" rel="stylesheet" />
	<meta content="text/html; charset=utf-8" http-equiv="Content-Type">
</head>
<style>
	body {
		padding-top: 0px;
	}
	
	.col-center-block {
		float: none;
		display: block;
		margin-left: auto;
		margin-right: auto;
	}
</style>
<script src="./js/core.js"></script>
<script src="./js/jquery.min.js"></script>

<body>
	<div id="content">
		<div id="containermain" class="container">
			<script>
				function guessFilenameFromUri(uri) {
					var arr = uri.split('/');
					if (arr.length > 0) {
						return arr[arr.length - 1];
					} else {
						return 'undefined';
					}
				}
				function downloadm3u8(filename) {
					console.log(filename);
					$.get('http://localhost:3001/' + filename, function (data) {
						var httparray = [];
						var arr = data.toString().split('\n');
						for (var i = 0; i < arr.length; i++) {
							if (arr[i].indexOf('http') != -1) {
								//contains
								httparray.push(arr[i]);
							}
						}

						for (var i = 0; i < httparray.length; i++) {
							console.log(httparray[i]);
							$.get('/download?uri=' + httparray[i], function (ret) {
								console.log(ret);
							});
							$('#progressdownload').attr('style', 'width :' + (i + 1) * 100 / (httparray.length) + '%');
						}
						$.get('/parsem3u8?file=' + filename, function (ret) {
							console.log(ret);
						});
					});
					$('#videonow').append("<p align=\"center\"><video id=\"myvideo\" src=" + filename + "></video></p>");
					$('#myvideo').trigger('play');
				}
				$.get('http://localhost:3001/getm3u8', function (data) {
					data.forEach(function (element) {
						var str = "<button type=\"button\" onclick = \"downloadm3u8('" + element + "')\" class=\"btn btn-default btn-lg btn-block\">" + element + "</button>";
						$('#buttonnow').append(str);
					}, this);
				});
			</script>
			<div class="progress">
				<div id="progressdownload" class="progress-bar progress-bar-info" role="progressbar" aria-valuenow="60" aria-valuemin="0"
					aria-valuemax="100" style="width: 0%;">
				</div>
			</div>
			<div id="buttonnow" class="row">
			</div>
			<br>

			<div class="row">
				<div id="videonow">
				</div>
			</div>
		</div>
	</div>
</body>

</html>